{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Class Discussion</h1>
    <!-- THIS IS THE NEW BUTTON -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newPostModal">
        + New Post
    </button>
</div>
<form action="{{ url_for('search') }}" method="get" class="mb-4">
    <div class="input-group">
        <input type="text" class="form-control" placeholder="Search by keyword, error message, or topic..." name="query" value="{{ search_query or '' }}">
        <button class="btn btn-outline-secondary" type="submit">Search</button>
    </div>
</form>
<!-- This is where we loop through the 'posts' data from app.py -->
{% for post in posts %}
<div class="card mb-3 post-card" style="cursor: pointer;"
     data-title="{{ post['title'] }}"
     data-full-question="{{ post['question_body'] }}"
     data-full-answer="{{ post['ai_response'] }}">

    <div class="card-header">
        <strong>{{ post['title'] }}</strong>
    </div>

    <div class="card-body">
        <!-- The 'truncate' filter shows only the first 200 characters -->
        <p class="card-text">{{ post['question_body'] | truncate(200) }}</p>
    </div>

    <div class="card-footer text-muted d-flex justify-content-between">
        <span>Topic: {{ post['topic'] }}</span>
        <div>
            <!-- These buttons are for looks right now -->
            <button class="btn btn-sm btn-outline-success">▲ Upvote ({{ post['upvotes'] }})</button>
            <button class="btn btn-sm btn-outline-danger">▼ Downvote ({{ post['downvotes'] }})</button>
        </div>
    </div>
</div>
{% endfor %}

<!-- This JavaScript makes the right sidebar appear when you click a post -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const postCards = document.querySelectorAll('.post-card');
    const rightSidebar = document.getElementById('right-sidebar-details');
    const detailsTitle = document.getElementById('details-title');
    const detailsQuestion = document.getElementById('details-question');
    const detailsAnswer = document.getElementById('details-answer');

    postCards.forEach(card => {
        card.addEventListener('click', function() {
            // Get the data stored on the card element you clicked
            const title = this.dataset.title;
            const question = this.dataset.fullQuestion;
            const answer = this.dataset.fullAnswer;

            // Put that data into the right sidebar's elements
            detailsTitle.innerText = title;
            detailsQuestion.innerText = question;
            detailsAnswer.innerText = answer;

            // Make the sidebar visible by removing the 'd-none' (display: none) class
            rightSidebar.classList.remove('d-none');
        });
    });
});
</script>

<!-- New Post Modal -->
<div class="modal fade" id="newPostModal" tabindex="-1" aria-labelledby="newPostModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newPostModalLabel">Ask a New Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- The form will send data to our new '/add_post' route -->
            <form action="{{ url_for('add_post') }}" method="post">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="postTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="postTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="postTopic" class="form-label">Topic</label>
                        <select class="form-select" id="postTopic" name="topic" required>
                            <option selected disabled value="">Choose a topic...</option>
                            <option>General</option>
                            <option>Lectures</option>
                            <option>Projects</option>
                            <option>R Syntax</option>
                            <option>ggplot2</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="postQuestion" class="form-label">Question / Error Message</label>
                        <textarea class="form-control" id="postQuestion" name="question_body" rows="6" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Ask AI Assistant</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}